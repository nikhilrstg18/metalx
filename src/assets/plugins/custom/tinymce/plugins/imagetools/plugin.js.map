{"version":3,"sources":["imagetools/plugin.js"],"names":["type","eq","call","id","Cell","initial","value","get","set","v","global","tinymce","util","Tools","resolve","global$1","isNonNullable","a","isNullable","isFunction","noop","constant","never","always","none","NONE","o","isNone","fold","n","_s","is","isSome","getOr","getOrThunk","thunk","getOrDie","msg","Error","getOrNull","getOrUndefined","undefined","or","orThunk","map","each","bind","exists","forall","filter","equals","equals_","toArray","toString","some","constant_a","self","me","f","s","elementEq","b","Optional","from","create","width","height","resize","document","createElement","clone","canvas","tCanvas","get2dContext","drawImage","getContext","Promise","window","fn","this","TypeError","_state","_value","_deferreds","doResolve","reject","anyWindow","asap","immediateFn","setImmediate","setTimeout","thisArg","args","_i","arguments","length","apply","isArray","Array","Object","prototype","handle","deferred","cb","onFulfilled","onRejected","ret","e","push","newValue","then","finale","_a","Handler","done","reason","ex","catch","all","values","slice","remaining","res","i","val","constructor","race","values_1","promise","blobToImage","blob","blobUrl","URL","createObjectURL","image","Image","removeListeners","removeEventListener","loaded","error","addEventListener","src","complete","anyUriToBlob","url","xhr","XMLHttpRequest","open","responseType","onload","status","response","onerror","obj","_this","code","name","send","dataUriToBlob","uri","data","split","matches","exec","mimetype","base64","sliceSize","byteCharacters","atob","bytesLength","slicesCount","Math","ceil","byteArrays","sliceIndex","begin","end","min","bytes","offset","charCodeAt","Uint8Array","Blob","dataUriToBlobSync","canvasToBlob","quality","HTMLCanvasElement","toBlob","toDataURL","revokeImageUrl","revokeObjectURL","imageToBlob$1","indexOf","imageToBlob","find","xs","pred","until","len","x","findUntil","create$1","getCanvas","initialType","getType","toAdjustedDataURL","canvasToDataURL","toBase64","toAdjustedBlob","toAdjustedBase64","dataurl","toCanvas","fromBlob","reader","FileReader","onloadend","result","readAsDataURL","blobToDataUri","naturalWidth","getWidth","naturalHeight","getHeight","blobToCanvas","fromCanvas","ceilWithPrecision","num","precision","mul","pow","upper","round","applyRotate","angle","rad","PI","sin","cos","newWidth","abs","newHeight","context","translate","rotate","applyFlip","axis","scale","flip$1","ir","flip","rotate$1","keys","sendRequest","headers","withCredentials","onreadystatechange","readyState","props","k","each$1","key","setRequestHeader","friendlyHttpErrors","message","friendlyServiceErrors","handleHttpError","getHttpErrorMsg","getServiceErrorMsg","getServiceError","text","JSON","parse","parseJson","err","json","path","acc","handleServiceError","readAsText","readBlobText","serviceError","isError","requestServiceBlob","apiKey","separator","test","encodeURIComponent","appendApiKey","isServiceErrorCode","getUrl","requestBlob","blobToImageResult","fromDom","node","dom","SugarElement","fromHtml","html","scope","div","innerHTML","hasChildNodes","childNodes","console","fromTag","tag","fromText","createTextNode","fromPoint","docElm","y","elementFromPoint","child$1","Function","selector","predicate","child","element","nodeType","elem","msMatchesSelector","webkitMatchesSelector","mozMatchesSelector","global$2","global$3","global$4","getToolbarItems","editor","getParam","getProxyUrl","getImageSize","img","isPxValue","style","w","parseInt","h","getNaturalImageSize","count","getFigureImg","isFigure","isImage","imgNode","getEditableImage","isEditable","isLocalImage","isCorsImage","displayError","notificationManager","getSelectedImage","selection","getNode","figureElm","getParent","extractFilename","group","m","match","encode","host","documentBaseURI","inArray","getCorsHosts","defaultFetchImage","getCredentialsHosts","isCorsWithCredentialsImage","proxyUrl","getApiKey","imageToBlob$2","getFetchImage","customFetchImage","findBlob","blobInfo","editorUpload","blobCache","getByUri","cancelTimedUpload","imageUploadTimerState","clearTimeout","updateSelectedImage","origBlob","uploadImmediately","selectedImage","size","filename","useFilename","shouldReuseFilename","add","undoManager","transact","imageLoadedHandler","$","off","nodeChanged","uploadImagesAuto","imageUploadTimer","setEditorTimeout","getUploadTimeout","startTimedUpload","on","attr","blobUri","removeAttr","selectedImageOperation","_scanForImages","imageResult","rotate$2","flippedSize","flip$2","handleDialogBlob","originalSize","blobToImage$1","newImage","newSize","removeAttribute","setAttribute","String","setImageSize","makeOpen","originalImgOpt","originalSizeOpt","origImg","_","state","createState","windowManager","title","body","items","label","currentState","buttons","primary","disabled","onSubmit","api","getData","imagetools","originalImg","close","onCancel","onAction","details","enable","disable","lastSelectedImageState","mceImageRotateLeft","mceImageRotateRight","mceImageFlipVertical","mceImageFlipHorizontal","mceEditImage","cmd","addCommand","register","command","execCommand","ui","registry","addButton","tooltip","icon","onSetup","buttonApi","setDisabled","addContextMenu","update","register$1","addContextToolbar","position","register$2","lastSelectedImage","setup"],"mappings":"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","file":"plugin.js","sourcesContent":["/**\n * Copyright (c) Tiny Technologies, Inc. All rights reserved.\n * Licensed under the LGPL or a commercial license.\n * For LGPL see License.txt in the project root for license information.\n * For commercial licenses see https://www.tiny.cloud/\n *\n * Version: 5.8.2 (2021-06-23)\n */\n(function () {\n    'use strict';\n\n    var Cell = function (initial) {\n      var value = initial;\n      var get = function () {\n        return value;\n      };\n      var set = function (v) {\n        value = v;\n      };\n      return {\n        get: get,\n        set: set\n      };\n    };\n\n    var global = tinymce.util.Tools.resolve('tinymce.PluginManager');\n\n    var global$1 = tinymce.util.Tools.resolve('tinymce.util.Tools');\n\n    var isSimpleType = function (type) {\n      return function (value) {\n        return typeof value === type;\n      };\n    };\n    var isNullable = function (a) {\n      return a === null || a === undefined;\n    };\n    var isNonNullable = function (a) {\n      return !isNullable(a);\n    };\n    var isFunction = isSimpleType('function');\n\n    var noop = function () {\n    };\n    var constant = function (value) {\n      return function () {\n        return value;\n      };\n    };\n    var never = constant(false);\n    var always = constant(true);\n\n    var none = function () {\n      return NONE;\n    };\n    var NONE = function () {\n      var eq = function (o) {\n        return o.isNone();\n      };\n      var call = function (thunk) {\n        return thunk();\n      };\n      var id = function (n) {\n        return n;\n      };\n      var me = {\n        fold: function (n, _s) {\n          return n();\n        },\n        is: never,\n        isSome: never,\n        isNone: always,\n        getOr: id,\n        getOrThunk: call,\n        getOrDie: function (msg) {\n          throw new Error(msg || 'error: getOrDie called on none.');\n        },\n        getOrNull: constant(null),\n        getOrUndefined: constant(undefined),\n        or: id,\n        orThunk: call,\n        map: none,\n        each: noop,\n        bind: none,\n        exists: never,\n        forall: always,\n        filter: none,\n        equals: eq,\n        equals_: eq,\n        toArray: function () {\n          return [];\n        },\n        toString: constant('none()')\n      };\n      return me;\n    }();\n    var some = function (a) {\n      var constant_a = constant(a);\n      var self = function () {\n        return me;\n      };\n      var bind = function (f) {\n        return f(a);\n      };\n      var me = {\n        fold: function (n, s) {\n          return s(a);\n        },\n        is: function (v) {\n          return a === v;\n        },\n        isSome: always,\n        isNone: never,\n        getOr: constant_a,\n        getOrThunk: constant_a,\n        getOrDie: constant_a,\n        getOrNull: constant_a,\n        getOrUndefined: constant_a,\n        or: self,\n        orThunk: self,\n        map: function (f) {\n          return some(f(a));\n        },\n        each: function (f) {\n          f(a);\n        },\n        bind: bind,\n        exists: bind,\n        forall: bind,\n        filter: function (f) {\n          return f(a) ? me : NONE;\n        },\n        toArray: function () {\n          return [a];\n        },\n        toString: function () {\n          return 'some(' + a + ')';\n        },\n        equals: function (o) {\n          return o.is(a);\n        },\n        equals_: function (o, elementEq) {\n          return o.fold(never, function (b) {\n            return elementEq(a, b);\n          });\n        }\n      };\n      return me;\n    };\n    var from = function (value) {\n      return value === null || value === undefined ? NONE : some(value);\n    };\n    var Optional = {\n      some: some,\n      none: none,\n      from: from\n    };\n\n    var create = function (width, height) {\n      return resize(document.createElement('canvas'), width, height);\n    };\n    var clone = function (canvas) {\n      var tCanvas = create(canvas.width, canvas.height);\n      var ctx = get2dContext(tCanvas);\n      ctx.drawImage(canvas, 0, 0);\n      return tCanvas;\n    };\n    var get2dContext = function (canvas) {\n      return canvas.getContext('2d');\n    };\n    var resize = function (canvas, width, height) {\n      canvas.width = width;\n      canvas.height = height;\n      return canvas;\n    };\n\n    var getWidth = function (image) {\n      return image.naturalWidth || image.width;\n    };\n    var getHeight = function (image) {\n      return image.naturalHeight || image.height;\n    };\n\n    var promise = function () {\n      var Promise = function (fn) {\n        if (typeof this !== 'object') {\n          throw new TypeError('Promises must be constructed via new');\n        }\n        if (typeof fn !== 'function') {\n          throw new TypeError('not a function');\n        }\n        this._state = null;\n        this._value = null;\n        this._deferreds = [];\n        doResolve(fn, bind(resolve, this), bind(reject, this));\n      };\n      var anyWindow = window;\n      var asap = Promise.immediateFn || typeof anyWindow.setImmediate === 'function' && anyWindow.setImmediate || function (fn) {\n        return setTimeout(fn, 1);\n      };\n      var bind = function (fn, thisArg) {\n        return function () {\n          var args = [];\n          for (var _i = 0; _i < arguments.length; _i++) {\n            args[_i] = arguments[_i];\n          }\n          return fn.apply(thisArg, args);\n        };\n      };\n      var isArray = Array.isArray || function (value) {\n        return Object.prototype.toString.call(value) === '[object Array]';\n      };\n      function handle(deferred) {\n        var me = this;\n        if (this._state === null) {\n          this._deferreds.push(deferred);\n          return;\n        }\n        asap(function () {\n          var cb = me._state ? deferred.onFulfilled : deferred.onRejected;\n          if (cb === null) {\n            (me._state ? deferred.resolve : deferred.reject)(me._value);\n            return;\n          }\n          var ret;\n          try {\n            ret = cb(me._value);\n          } catch (e) {\n            deferred.reject(e);\n            return;\n          }\n          deferred.resolve(ret);\n        });\n      }\n      function resolve(newValue) {\n        try {\n          if (newValue === this) {\n            throw new TypeError('A promise cannot be resolved with itself.');\n          }\n          if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {\n            var then = newValue.then;\n            if (typeof then === 'function') {\n              doResolve(bind(then, newValue), bind(resolve, this), bind(reject, this));\n              return;\n            }\n          }\n          this._state = true;\n          this._value = newValue;\n          finale.call(this);\n        } catch (e) {\n          reject.call(this, e);\n        }\n      }\n      function reject(newValue) {\n        this._state = false;\n        this._value = newValue;\n        finale.call(this);\n      }\n      function finale() {\n        for (var _i = 0, _a = this._deferreds; _i < _a.length; _i++) {\n          var deferred = _a[_i];\n          handle.call(this, deferred);\n        }\n        this._deferreds = [];\n      }\n      function Handler(onFulfilled, onRejected, resolve, reject) {\n        this.onFulfilled = typeof onFulfilled === 'function' ? onFulfilled : null;\n        this.onRejected = typeof onRejected === 'function' ? onRejected : null;\n        this.resolve = resolve;\n        this.reject = reject;\n      }\n      var doResolve = function (fn, onFulfilled, onRejected) {\n        var done = false;\n        try {\n          fn(function (value) {\n            if (done) {\n              return;\n            }\n            done = true;\n            onFulfilled(value);\n          }, function (reason) {\n            if (done) {\n              return;\n            }\n            done = true;\n            onRejected(reason);\n          });\n        } catch (ex) {\n          if (done) {\n            return;\n          }\n          done = true;\n          onRejected(ex);\n        }\n      };\n      Promise.prototype.catch = function (onRejected) {\n        return this.then(null, onRejected);\n      };\n      Promise.prototype.then = function (onFulfilled, onRejected) {\n        var me = this;\n        return new Promise(function (resolve, reject) {\n          handle.call(me, new Handler(onFulfilled, onRejected, resolve, reject));\n        });\n      };\n      Promise.all = function () {\n        var values = [];\n        for (var _i = 0; _i < arguments.length; _i++) {\n          values[_i] = arguments[_i];\n        }\n        var args = Array.prototype.slice.call(values.length === 1 && isArray(values[0]) ? values[0] : values);\n        return new Promise(function (resolve, reject) {\n          if (args.length === 0) {\n            return resolve([]);\n          }\n          var remaining = args.length;\n          var res = function (i, val) {\n            try {\n              if (val && (typeof val === 'object' || typeof val === 'function')) {\n                var then = val.then;\n                if (typeof then === 'function') {\n                  then.call(val, function (val) {\n                    res(i, val);\n                  }, reject);\n                  return;\n                }\n              }\n              args[i] = val;\n              if (--remaining === 0) {\n                resolve(args);\n              }\n            } catch (ex) {\n              reject(ex);\n            }\n          };\n          for (var i = 0; i < args.length; i++) {\n            res(i, args[i]);\n          }\n        });\n      };\n      Promise.resolve = function (value) {\n        if (value && typeof value === 'object' && value.constructor === Promise) {\n          return value;\n        }\n        return new Promise(function (resolve) {\n          resolve(value);\n        });\n      };\n      Promise.reject = function (reason) {\n        return new Promise(function (resolve, reject) {\n          reject(reason);\n        });\n      };\n      Promise.race = function (values) {\n        return new Promise(function (resolve, reject) {\n          for (var _i = 0, values_1 = values; _i < values_1.length; _i++) {\n            var value = values_1[_i];\n            value.then(resolve, reject);\n          }\n        });\n      };\n      return Promise;\n    };\n    var Promise = window.Promise ? window.Promise : promise();\n\n    var imageToBlob = function (image) {\n      var src = image.src;\n      if (src.indexOf('data:') === 0) {\n        return dataUriToBlob(src);\n      }\n      return anyUriToBlob(src);\n    };\n    var blobToImage = function (blob) {\n      return new Promise(function (resolve, reject) {\n        var blobUrl = URL.createObjectURL(blob);\n        var image = new Image();\n        var removeListeners = function () {\n          image.removeEventListener('load', loaded);\n          image.removeEventListener('error', error);\n        };\n        var loaded = function () {\n          removeListeners();\n          resolve(image);\n        };\n        var error = function () {\n          removeListeners();\n          reject('Unable to load data of type ' + blob.type + ': ' + blobUrl);\n        };\n        image.addEventListener('load', loaded);\n        image.addEventListener('error', error);\n        image.src = blobUrl;\n        if (image.complete) {\n          setTimeout(loaded, 0);\n        }\n      });\n    };\n    var anyUriToBlob = function (url) {\n      return new Promise(function (resolve, reject) {\n        var xhr = new XMLHttpRequest();\n        xhr.open('GET', url, true);\n        xhr.responseType = 'blob';\n        xhr.onload = function () {\n          if (this.status === 200) {\n            resolve(this.response);\n          }\n        };\n        xhr.onerror = function () {\n          var _this = this;\n          var corsError = function () {\n            var obj = new Error('No access to download image');\n            obj.code = 18;\n            obj.name = 'SecurityError';\n            return obj;\n          };\n          var genericError = function () {\n            return new Error('Error ' + _this.status + ' downloading image');\n          };\n          reject(this.status === 0 ? corsError() : genericError());\n        };\n        xhr.send();\n      });\n    };\n    var dataUriToBlobSync = function (uri) {\n      var data = uri.split(',');\n      var matches = /data:([^;]+)/.exec(data[0]);\n      if (!matches) {\n        return Optional.none();\n      }\n      var mimetype = matches[1];\n      var base64 = data[1];\n      var sliceSize = 1024;\n      var byteCharacters = atob(base64);\n      var bytesLength = byteCharacters.length;\n      var slicesCount = Math.ceil(bytesLength / sliceSize);\n      var byteArrays = new Array(slicesCount);\n      for (var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {\n        var begin = sliceIndex * sliceSize;\n        var end = Math.min(begin + sliceSize, bytesLength);\n        var bytes = new Array(end - begin);\n        for (var offset = begin, i = 0; offset < end; ++i, ++offset) {\n          bytes[i] = byteCharacters[offset].charCodeAt(0);\n        }\n        byteArrays[sliceIndex] = new Uint8Array(bytes);\n      }\n      return Optional.some(new Blob(byteArrays, { type: mimetype }));\n    };\n    var dataUriToBlob = function (uri) {\n      return new Promise(function (resolve, reject) {\n        dataUriToBlobSync(uri).fold(function () {\n          reject('uri is not base64: ' + uri);\n        }, resolve);\n      });\n    };\n    var canvasToBlob = function (canvas, type, quality) {\n      type = type || 'image/png';\n      if (isFunction(HTMLCanvasElement.prototype.toBlob)) {\n        return new Promise(function (resolve, reject) {\n          canvas.toBlob(function (blob) {\n            if (blob) {\n              resolve(blob);\n            } else {\n              reject();\n            }\n          }, type, quality);\n        });\n      } else {\n        return dataUriToBlob(canvas.toDataURL(type, quality));\n      }\n    };\n    var canvasToDataURL = function (canvas, type, quality) {\n      type = type || 'image/png';\n      return canvas.toDataURL(type, quality);\n    };\n    var blobToCanvas = function (blob) {\n      return blobToImage(blob).then(function (image) {\n        revokeImageUrl(image);\n        var canvas = create(getWidth(image), getHeight(image));\n        var context = get2dContext(canvas);\n        context.drawImage(image, 0, 0);\n        return canvas;\n      });\n    };\n    var blobToDataUri = function (blob) {\n      return new Promise(function (resolve) {\n        var reader = new FileReader();\n        reader.onloadend = function () {\n          resolve(reader.result);\n        };\n        reader.readAsDataURL(blob);\n      });\n    };\n    var revokeImageUrl = function (image) {\n      URL.revokeObjectURL(image.src);\n    };\n\n    var blobToImage$1 = function (blob) {\n      return blobToImage(blob);\n    };\n    var imageToBlob$1 = function (image) {\n      return imageToBlob(image);\n    };\n\n    var each = function (xs, f) {\n      for (var i = 0, len = xs.length; i < len; i++) {\n        var x = xs[i];\n        f(x, i);\n      }\n    };\n    var foldl = function (xs, f, acc) {\n      each(xs, function (x) {\n        acc = f(acc, x);\n      });\n      return acc;\n    };\n    var findUntil = function (xs, pred, until) {\n      for (var i = 0, len = xs.length; i < len; i++) {\n        var x = xs[i];\n        if (pred(x, i)) {\n          return Optional.some(x);\n        } else if (until(x, i)) {\n          break;\n        }\n      }\n      return Optional.none();\n    };\n    var find = function (xs, pred) {\n      return findUntil(xs, pred, never);\n    };\n\n    var create$1 = function (getCanvas, blob, uri) {\n      var initialType = blob.type;\n      var getType = constant(initialType);\n      var toBlob = function () {\n        return Promise.resolve(blob);\n      };\n      var toDataURL = constant(uri);\n      var toBase64 = function () {\n        return uri.split(',')[1];\n      };\n      var toAdjustedBlob = function (type, quality) {\n        return getCanvas.then(function (canvas) {\n          return canvasToBlob(canvas, type, quality);\n        });\n      };\n      var toAdjustedDataURL = function (type, quality) {\n        return getCanvas.then(function (canvas) {\n          return canvasToDataURL(canvas, type, quality);\n        });\n      };\n      var toAdjustedBase64 = function (type, quality) {\n        return toAdjustedDataURL(type, quality).then(function (dataurl) {\n          return dataurl.split(',')[1];\n        });\n      };\n      var toCanvas = function () {\n        return getCanvas.then(clone);\n      };\n      return {\n        getType: getType,\n        toBlob: toBlob,\n        toDataURL: toDataURL,\n        toBase64: toBase64,\n        toAdjustedBlob: toAdjustedBlob,\n        toAdjustedDataURL: toAdjustedDataURL,\n        toAdjustedBase64: toAdjustedBase64,\n        toCanvas: toCanvas\n      };\n    };\n    var fromBlob = function (blob) {\n      return blobToDataUri(blob).then(function (uri) {\n        return create$1(blobToCanvas(blob), blob, uri);\n      });\n    };\n    var fromCanvas = function (canvas, type) {\n      return canvasToBlob(canvas, type).then(function (blob) {\n        return create$1(Promise.resolve(canvas), blob, canvas.toDataURL());\n      });\n    };\n\n    var ceilWithPrecision = function (num, precision) {\n      if (precision === void 0) {\n        precision = 2;\n      }\n      var mul = Math.pow(10, precision);\n      var upper = Math.round(num * mul);\n      return Math.ceil(upper / mul);\n    };\n    var rotate = function (ir, angle) {\n      return ir.toCanvas().then(function (canvas) {\n        return applyRotate(canvas, ir.getType(), angle);\n      });\n    };\n    var applyRotate = function (image, type, angle) {\n      var degrees = angle < 0 ? 360 + angle : angle;\n      var rad = degrees * Math.PI / 180;\n      var width = image.width;\n      var height = image.height;\n      var sin = Math.sin(rad);\n      var cos = Math.cos(rad);\n      var newWidth = ceilWithPrecision(Math.abs(width * cos) + Math.abs(height * sin));\n      var newHeight = ceilWithPrecision(Math.abs(width * sin) + Math.abs(height * cos));\n      var canvas = create(newWidth, newHeight);\n      var context = get2dContext(canvas);\n      context.translate(newWidth / 2, newHeight / 2);\n      context.rotate(rad);\n      context.drawImage(image, -width / 2, -height / 2);\n      return fromCanvas(canvas, type);\n    };\n    var flip = function (ir, axis) {\n      return ir.toCanvas().then(function (canvas) {\n        return applyFlip(canvas, ir.getType(), axis);\n      });\n    };\n    var applyFlip = function (image, type, axis) {\n      var canvas = create(image.width, image.height);\n      var context = get2dContext(canvas);\n      if (axis === 'v') {\n        context.scale(1, -1);\n        context.drawImage(image, 0, -canvas.height);\n      } else {\n        context.scale(-1, 1);\n        context.drawImage(image, -canvas.width, 0);\n      }\n      return fromCanvas(canvas, type);\n    };\n\n    var flip$1 = function (ir, axis) {\n      return flip(ir, axis);\n    };\n    var rotate$1 = function (ir, angle) {\n      return rotate(ir, angle);\n    };\n\n    var keys = Object.keys;\n    var each$1 = function (obj, f) {\n      var props = keys(obj);\n      for (var k = 0, len = props.length; k < len; k++) {\n        var i = props[k];\n        var x = obj[i];\n        f(x, i);\n      }\n    };\n\n    var sendRequest = function (url, headers, withCredentials) {\n      if (withCredentials === void 0) {\n        withCredentials = false;\n      }\n      return new Promise(function (resolve) {\n        var xhr = new XMLHttpRequest();\n        xhr.onreadystatechange = function () {\n          if (xhr.readyState === 4) {\n            resolve({\n              status: xhr.status,\n              blob: xhr.response\n            });\n          }\n        };\n        xhr.open('GET', url, true);\n        xhr.withCredentials = withCredentials;\n        each$1(headers, function (value, key) {\n          xhr.setRequestHeader(key, value);\n        });\n        xhr.responseType = 'blob';\n        xhr.send();\n      });\n    };\n    var readBlobText = function (blob) {\n      return new Promise(function (resolve, reject) {\n        var reader = new FileReader();\n        reader.onload = function () {\n          resolve(reader.result);\n        };\n        reader.onerror = function (e) {\n          reject(e);\n        };\n        reader.readAsText(blob);\n      });\n    };\n    var parseJson = function (text) {\n      try {\n        return Optional.some(JSON.parse(text));\n      } catch (ex) {\n        return Optional.none();\n      }\n    };\n\n    var friendlyHttpErrors = [\n      {\n        code: 404,\n        message: 'Could not find Image Proxy'\n      },\n      {\n        code: 403,\n        message: 'Rejected request'\n      },\n      {\n        code: 0,\n        message: 'Incorrect Image Proxy URL'\n      }\n    ];\n    var friendlyServiceErrors = [\n      {\n        type: 'not_found',\n        message: 'Failed to load image.'\n      },\n      {\n        type: 'key_missing',\n        message: 'The request did not include an api key.'\n      },\n      {\n        type: 'key_not_found',\n        message: 'The provided api key could not be found.'\n      },\n      {\n        type: 'domain_not_trusted',\n        message: 'The api key is not valid for the request origins.'\n      }\n    ];\n    var traverseJson = function (json, path) {\n      var value = foldl(path, function (result, key) {\n        return isNonNullable(result) ? result[key] : undefined;\n      }, json);\n      return Optional.from(value);\n    };\n    var isServiceErrorCode = function (code, blob) {\n      return (blob === null || blob === void 0 ? void 0 : blob.type) === 'application/json' && (code === 400 || code === 403 || code === 404 || code === 500);\n    };\n    var getHttpErrorMsg = function (status) {\n      var message = find(friendlyHttpErrors, function (error) {\n        return status === error.code;\n      }).fold(constant('Unknown ImageProxy error'), function (error) {\n        return error.message;\n      });\n      return 'ImageProxy HTTP error: ' + message;\n    };\n    var handleHttpError = function (status) {\n      var message = getHttpErrorMsg(status);\n      return Promise.reject(message);\n    };\n    var getServiceErrorMsg = function (type) {\n      return find(friendlyServiceErrors, function (error) {\n        return error.type === type;\n      }).fold(constant('Unknown service error'), function (error) {\n        return error.message;\n      });\n    };\n    var getServiceError = function (text) {\n      var serviceError = parseJson(text);\n      var errorMsg = serviceError.bind(function (err) {\n        return traverseJson(err, [\n          'error',\n          'type'\n        ]).map(getServiceErrorMsg);\n      }).getOr('Invalid JSON in service error message');\n      return 'ImageProxy Service error: ' + errorMsg;\n    };\n    var handleServiceError = function (blob) {\n      return readBlobText(blob).then(function (text) {\n        var serviceError = getServiceError(text);\n        return Promise.reject(serviceError);\n      });\n    };\n    var handleServiceErrorResponse = function (status, blob) {\n      return isServiceErrorCode(status, blob) ? handleServiceError(blob) : handleHttpError(status);\n    };\n\n    var appendApiKey = function (url, apiKey) {\n      var separator = url.indexOf('?') === -1 ? '?' : '&';\n      if (/[?&]apiKey=/.test(url)) {\n        return url;\n      } else {\n        return url + separator + 'apiKey=' + encodeURIComponent(apiKey);\n      }\n    };\n    var isError = function (status) {\n      return status < 200 || status >= 300;\n    };\n    var requestServiceBlob = function (url, apiKey) {\n      var headers = {\n        'Content-Type': 'application/json;charset=UTF-8',\n        'tiny-api-key': apiKey\n      };\n      return sendRequest(appendApiKey(url, apiKey), headers).then(function (result) {\n        return isError(result.status) ? handleServiceErrorResponse(result.status, result.blob) : Promise.resolve(result.blob);\n      });\n    };\n    var requestBlob = function (url, withCredentials) {\n      return sendRequest(url, {}, withCredentials).then(function (result) {\n        return isError(result.status) ? handleHttpError(result.status) : Promise.resolve(result.blob);\n      });\n    };\n    var getUrl = function (url, apiKey, withCredentials) {\n      if (withCredentials === void 0) {\n        withCredentials = false;\n      }\n      return apiKey ? requestServiceBlob(url, apiKey) : requestBlob(url, withCredentials);\n    };\n\n    var blobToImageResult = function (blob) {\n      return fromBlob(blob);\n    };\n\n    var ELEMENT = 1;\n\n    var fromHtml = function (html, scope) {\n      var doc = scope || document;\n      var div = doc.createElement('div');\n      div.innerHTML = html;\n      if (!div.hasChildNodes() || div.childNodes.length > 1) {\n        console.error('HTML does not have a single root node', html);\n        throw new Error('HTML must have a single root node');\n      }\n      return fromDom(div.childNodes[0]);\n    };\n    var fromTag = function (tag, scope) {\n      var doc = scope || document;\n      var node = doc.createElement(tag);\n      return fromDom(node);\n    };\n    var fromText = function (text, scope) {\n      var doc = scope || document;\n      var node = doc.createTextNode(text);\n      return fromDom(node);\n    };\n    var fromDom = function (node) {\n      if (node === null || node === undefined) {\n        throw new Error('Node cannot be null or undefined');\n      }\n      return { dom: node };\n    };\n    var fromPoint = function (docElm, x, y) {\n      return Optional.from(docElm.dom.elementFromPoint(x, y)).map(fromDom);\n    };\n    var SugarElement = {\n      fromHtml: fromHtml,\n      fromTag: fromTag,\n      fromText: fromText,\n      fromDom: fromDom,\n      fromPoint: fromPoint\n    };\n\n    var is = function (element, selector) {\n      var dom = element.dom;\n      if (dom.nodeType !== ELEMENT) {\n        return false;\n      } else {\n        var elem = dom;\n        if (elem.matches !== undefined) {\n          return elem.matches(selector);\n        } else if (elem.msMatchesSelector !== undefined) {\n          return elem.msMatchesSelector(selector);\n        } else if (elem.webkitMatchesSelector !== undefined) {\n          return elem.webkitMatchesSelector(selector);\n        } else if (elem.mozMatchesSelector !== undefined) {\n          return elem.mozMatchesSelector(selector);\n        } else {\n          throw new Error('Browser lacks native selectors');\n        }\n      }\n    };\n\n    var Global = typeof window !== 'undefined' ? window : Function('return this;')();\n\n    var child = function (scope, predicate) {\n      var pred = function (node) {\n        return predicate(SugarElement.fromDom(node));\n      };\n      var result = find(scope.dom.childNodes, pred);\n      return result.map(SugarElement.fromDom);\n    };\n\n    var child$1 = function (scope, selector) {\n      return child(scope, function (e) {\n        return is(e, selector);\n      });\n    };\n\n    var global$2 = tinymce.util.Tools.resolve('tinymce.util.Delay');\n\n    var global$3 = tinymce.util.Tools.resolve('tinymce.util.Promise');\n\n    var global$4 = tinymce.util.Tools.resolve('tinymce.util.URI');\n\n    var getToolbarItems = function (editor) {\n      return editor.getParam('imagetools_toolbar', 'rotateleft rotateright flipv fliph editimage imageoptions');\n    };\n    var getProxyUrl = function (editor) {\n      return editor.getParam('imagetools_proxy');\n    };\n    var getCorsHosts = function (editor) {\n      return editor.getParam('imagetools_cors_hosts', [], 'string[]');\n    };\n    var getCredentialsHosts = function (editor) {\n      return editor.getParam('imagetools_credentials_hosts', [], 'string[]');\n    };\n    var getFetchImage = function (editor) {\n      return Optional.from(editor.getParam('imagetools_fetch_image', null, 'function'));\n    };\n    var getApiKey = function (editor) {\n      return editor.getParam('api_key', editor.getParam('imagetools_api_key', '', 'string'), 'string');\n    };\n    var getUploadTimeout = function (editor) {\n      return editor.getParam('images_upload_timeout', 30000, 'number');\n    };\n    var shouldReuseFilename = function (editor) {\n      return editor.getParam('images_reuse_filename', false, 'boolean');\n    };\n\n    var getImageSize = function (img) {\n      var width, height;\n      var isPxValue = function (value) {\n        return /^[0-9\\.]+px$/.test(value);\n      };\n      width = img.style.width;\n      height = img.style.height;\n      if (width || height) {\n        if (isPxValue(width) && isPxValue(height)) {\n          return {\n            w: parseInt(width, 10),\n            h: parseInt(height, 10)\n          };\n        }\n        return null;\n      }\n      width = img.width;\n      height = img.height;\n      if (width && height) {\n        return {\n          w: parseInt(width, 10),\n          h: parseInt(height, 10)\n        };\n      }\n      return null;\n    };\n    var setImageSize = function (img, size) {\n      var width, height;\n      if (size) {\n        width = img.style.width;\n        height = img.style.height;\n        if (width || height) {\n          img.style.width = size.w + 'px';\n          img.style.height = size.h + 'px';\n          img.removeAttribute('data-mce-style');\n        }\n        width = img.width;\n        height = img.height;\n        if (width || height) {\n          img.setAttribute('width', String(size.w));\n          img.setAttribute('height', String(size.h));\n        }\n      }\n    };\n    var getNaturalImageSize = function (img) {\n      return {\n        w: img.naturalWidth,\n        h: img.naturalHeight\n      };\n    };\n\n    var count = 0;\n    var getFigureImg = function (elem) {\n      return child$1(SugarElement.fromDom(elem), 'img');\n    };\n    var isFigure = function (editor, elem) {\n      return editor.dom.is(elem, 'figure');\n    };\n    var isImage = function (editor, imgNode) {\n      return editor.dom.is(imgNode, 'img:not([data-mce-object],[data-mce-placeholder])');\n    };\n    var getEditableImage = function (editor, node) {\n      var isEditable = function (imgNode) {\n        return isImage(editor, imgNode) && (isLocalImage(editor, imgNode) || isCorsImage(editor, imgNode) || isNonNullable(getProxyUrl(editor)));\n      };\n      if (isFigure(editor, node)) {\n        return getFigureImg(node).bind(function (img) {\n          return isEditable(img.dom) ? Optional.some(img.dom) : Optional.none();\n        });\n      } else {\n        return isEditable(node) ? Optional.some(node) : Optional.none();\n      }\n    };\n    var displayError = function (editor, error) {\n      editor.notificationManager.open({\n        text: error,\n        type: 'error'\n      });\n    };\n    var getSelectedImage = function (editor) {\n      var elem = editor.selection.getNode();\n      var figureElm = editor.dom.getParent(elem, 'figure.image');\n      if (figureElm !== null && isFigure(editor, figureElm)) {\n        return getFigureImg(figureElm);\n      } else if (isImage(editor, elem)) {\n        return Optional.some(SugarElement.fromDom(elem));\n      } else {\n        return Optional.none();\n      }\n    };\n    var extractFilename = function (editor, url, group) {\n      var m = url.match(/(?:\\/|^)(([^\\/\\?]+)\\.(?:[a-z0-9.]+))(?:\\?|$)/i);\n      return isNonNullable(m) ? editor.dom.encode(m[group]) : null;\n    };\n    var createId = function () {\n      return 'imagetools' + count++;\n    };\n    var isLocalImage = function (editor, img) {\n      var url = img.src;\n      return url.indexOf('data:') === 0 || url.indexOf('blob:') === 0 || new global$4(url).host === editor.documentBaseURI.host;\n    };\n    var isCorsImage = function (editor, img) {\n      return global$1.inArray(getCorsHosts(editor), new global$4(img.src).host) !== -1;\n    };\n    var isCorsWithCredentialsImage = function (editor, img) {\n      return global$1.inArray(getCredentialsHosts(editor), new global$4(img.src).host) !== -1;\n    };\n    var defaultFetchImage = function (editor, img) {\n      if (isCorsImage(editor, img)) {\n        return getUrl(img.src, null, isCorsWithCredentialsImage(editor, img));\n      }\n      if (!isLocalImage(editor, img)) {\n        var proxyUrl = getProxyUrl(editor);\n        var src = proxyUrl + (proxyUrl.indexOf('?') === -1 ? '?' : '&') + 'url=' + encodeURIComponent(img.src);\n        var apiKey = getApiKey(editor);\n        return getUrl(src, apiKey, false);\n      }\n      return imageToBlob$1(img);\n    };\n    var imageToBlob$2 = function (editor, img) {\n      return getFetchImage(editor).fold(function () {\n        return defaultFetchImage(editor, img);\n      }, function (customFetchImage) {\n        return customFetchImage(img);\n      });\n    };\n    var findBlob = function (editor, img) {\n      var blobInfo = editor.editorUpload.blobCache.getByUri(img.src);\n      if (blobInfo) {\n        return global$3.resolve(blobInfo.blob());\n      }\n      return imageToBlob$2(editor, img);\n    };\n    var startTimedUpload = function (editor, imageUploadTimerState) {\n      var imageUploadTimer = global$2.setEditorTimeout(editor, function () {\n        editor.editorUpload.uploadImagesAuto();\n      }, getUploadTimeout(editor));\n      imageUploadTimerState.set(imageUploadTimer);\n    };\n    var cancelTimedUpload = function (imageUploadTimerState) {\n      global$2.clearTimeout(imageUploadTimerState.get());\n    };\n    var updateSelectedImage = function (editor, origBlob, ir, uploadImmediately, imageUploadTimerState, selectedImage, size) {\n      return ir.toBlob().then(function (blob) {\n        var uri, name, filename, blobInfo;\n        var blobCache = editor.editorUpload.blobCache;\n        uri = selectedImage.src;\n        var useFilename = origBlob.type === blob.type;\n        if (shouldReuseFilename(editor)) {\n          blobInfo = blobCache.getByUri(uri);\n          if (isNonNullable(blobInfo)) {\n            uri = blobInfo.uri();\n            name = blobInfo.name();\n            filename = blobInfo.filename();\n          } else {\n            name = extractFilename(editor, uri, 2);\n            filename = extractFilename(editor, uri, 1);\n          }\n        }\n        blobInfo = blobCache.create({\n          id: createId(),\n          blob: blob,\n          base64: ir.toBase64(),\n          uri: uri,\n          name: name,\n          filename: useFilename ? filename : undefined\n        });\n        blobCache.add(blobInfo);\n        editor.undoManager.transact(function () {\n          var imageLoadedHandler = function () {\n            editor.$(selectedImage).off('load', imageLoadedHandler);\n            editor.nodeChanged();\n            if (uploadImmediately) {\n              editor.editorUpload.uploadImagesAuto();\n            } else {\n              cancelTimedUpload(imageUploadTimerState);\n              startTimedUpload(editor, imageUploadTimerState);\n            }\n          };\n          editor.$(selectedImage).on('load', imageLoadedHandler);\n          if (size) {\n            editor.$(selectedImage).attr({\n              width: size.w,\n              height: size.h\n            });\n          }\n          editor.$(selectedImage).attr({ src: blobInfo.blobUri() }).removeAttr('data-mce-src');\n        });\n        return blobInfo;\n      });\n    };\n    var selectedImageOperation = function (editor, imageUploadTimerState, fn, size) {\n      return function () {\n        var imgOpt = getSelectedImage(editor);\n        return imgOpt.fold(function () {\n          displayError(editor, 'Could not find selected image');\n        }, function (img) {\n          return editor._scanForImages().then(function () {\n            return findBlob(editor, img.dom);\n          }).then(function (blob) {\n            return blobToImageResult(blob).then(fn).then(function (imageResult) {\n              return updateSelectedImage(editor, blob, imageResult, false, imageUploadTimerState, img.dom, size);\n            });\n          }).catch(function (error) {\n            displayError(editor, error);\n          });\n        });\n      };\n    };\n    var rotate$2 = function (editor, imageUploadTimerState, angle) {\n      return function () {\n        var imgOpt = getSelectedImage(editor);\n        var flippedSize = imgOpt.fold(function () {\n          return null;\n        }, function (img) {\n          var size = getImageSize(img.dom);\n          return size ? {\n            w: size.h,\n            h: size.w\n          } : null;\n        });\n        return selectedImageOperation(editor, imageUploadTimerState, function (imageResult) {\n          return rotate$1(imageResult, angle);\n        }, flippedSize)();\n      };\n    };\n    var flip$2 = function (editor, imageUploadTimerState, axis) {\n      return function () {\n        return selectedImageOperation(editor, imageUploadTimerState, function (imageResult) {\n          return flip$1(imageResult, axis);\n        })();\n      };\n    };\n    var handleDialogBlob = function (editor, imageUploadTimerState, img, originalSize, blob) {\n      return blobToImage$1(blob).then(function (newImage) {\n        var newSize = getNaturalImageSize(newImage);\n        if (originalSize.w !== newSize.w || originalSize.h !== newSize.h) {\n          if (getImageSize(img)) {\n            setImageSize(img, newSize);\n          }\n        }\n        URL.revokeObjectURL(newImage.src);\n        return blob;\n      }).then(blobToImageResult).then(function (imageResult) {\n        return updateSelectedImage(editor, blob, imageResult, true, imageUploadTimerState, img);\n      });\n    };\n\n    var saveState = 'save-state';\n    var disable = 'disable';\n    var enable = 'enable';\n\n    var createState = function (blob) {\n      return {\n        blob: blob,\n        url: URL.createObjectURL(blob)\n      };\n    };\n    var makeOpen = function (editor, imageUploadTimerState) {\n      return function () {\n        var getLoadedSpec = function (currentState) {\n          return {\n            title: 'Edit Image',\n            size: 'large',\n            body: {\n              type: 'panel',\n              items: [{\n                  type: 'imagetools',\n                  name: 'imagetools',\n                  label: 'Edit Image',\n                  currentState: currentState\n                }]\n            },\n            buttons: [\n              {\n                type: 'cancel',\n                name: 'cancel',\n                text: 'Cancel'\n              },\n              {\n                type: 'submit',\n                name: 'save',\n                text: 'Save',\n                primary: true,\n                disabled: true\n              }\n            ],\n            onSubmit: function (api) {\n              var blob = api.getData().imagetools.blob;\n              originalImgOpt.each(function (originalImg) {\n                originalSizeOpt.each(function (originalSize) {\n                  handleDialogBlob(editor, imageUploadTimerState, originalImg.dom, originalSize, blob);\n                });\n              });\n              api.close();\n            },\n            onCancel: noop,\n            onAction: function (api, details) {\n              switch (details.name) {\n              case saveState:\n                if (details.value) {\n                  api.enable('save');\n                } else {\n                  api.disable('save');\n                }\n                break;\n              case disable:\n                api.disable('save');\n                api.disable('cancel');\n                break;\n              case enable:\n                api.enable('cancel');\n                break;\n              }\n            }\n          };\n        };\n        var originalImgOpt = getSelectedImage(editor);\n        var originalSizeOpt = originalImgOpt.map(function (origImg) {\n          return getNaturalImageSize(origImg.dom);\n        });\n        originalImgOpt.each(function (img) {\n          getEditableImage(editor, img.dom).each(function (_) {\n            findBlob(editor, img.dom).then(function (blob) {\n              var state = createState(blob);\n              editor.windowManager.open(getLoadedSpec(state));\n            });\n          });\n        });\n      };\n    };\n\n    var register = function (editor, imageUploadTimerState) {\n      global$1.each({\n        mceImageRotateLeft: rotate$2(editor, imageUploadTimerState, -90),\n        mceImageRotateRight: rotate$2(editor, imageUploadTimerState, 90),\n        mceImageFlipVertical: flip$2(editor, imageUploadTimerState, 'v'),\n        mceImageFlipHorizontal: flip$2(editor, imageUploadTimerState, 'h'),\n        mceEditImage: makeOpen(editor, imageUploadTimerState)\n      }, function (fn, cmd) {\n        editor.addCommand(cmd, fn);\n      });\n    };\n\n    var setup = function (editor, imageUploadTimerState, lastSelectedImageState) {\n      editor.on('NodeChange', function (e) {\n        var lastSelectedImage = lastSelectedImageState.get();\n        var selectedImage = getEditableImage(editor, e.element);\n        if (lastSelectedImage && !selectedImage.exists(function (img) {\n            return lastSelectedImage.src === img.src;\n          })) {\n          cancelTimedUpload(imageUploadTimerState);\n          editor.editorUpload.uploadImagesAuto();\n          lastSelectedImageState.set(null);\n        }\n        selectedImage.each(lastSelectedImageState.set);\n      });\n    };\n\n    var register$1 = function (editor) {\n      var cmd = function (command) {\n        return function () {\n          return editor.execCommand(command);\n        };\n      };\n      editor.ui.registry.addButton('rotateleft', {\n        tooltip: 'Rotate counterclockwise',\n        icon: 'rotate-left',\n        onAction: cmd('mceImageRotateLeft')\n      });\n      editor.ui.registry.addButton('rotateright', {\n        tooltip: 'Rotate clockwise',\n        icon: 'rotate-right',\n        onAction: cmd('mceImageRotateRight')\n      });\n      editor.ui.registry.addButton('flipv', {\n        tooltip: 'Flip vertically',\n        icon: 'flip-vertically',\n        onAction: cmd('mceImageFlipVertical')\n      });\n      editor.ui.registry.addButton('fliph', {\n        tooltip: 'Flip horizontally',\n        icon: 'flip-horizontally',\n        onAction: cmd('mceImageFlipHorizontal')\n      });\n      editor.ui.registry.addButton('editimage', {\n        tooltip: 'Edit image',\n        icon: 'edit-image',\n        onAction: cmd('mceEditImage'),\n        onSetup: function (buttonApi) {\n          var setDisabled = function () {\n            var disabled = getSelectedImage(editor).forall(function (element) {\n              return getEditableImage(editor, element.dom).isNone();\n            });\n            buttonApi.setDisabled(disabled);\n          };\n          editor.on('NodeChange', setDisabled);\n          return function () {\n            editor.off('NodeChange', setDisabled);\n          };\n        }\n      });\n      editor.ui.registry.addButton('imageoptions', {\n        tooltip: 'Image options',\n        icon: 'image',\n        onAction: cmd('mceImage')\n      });\n      editor.ui.registry.addContextMenu('imagetools', {\n        update: function (element) {\n          return getEditableImage(editor, element).fold(function () {\n            return [];\n          }, function (_) {\n            return [{\n                text: 'Edit image',\n                icon: 'edit-image',\n                onAction: cmd('mceEditImage')\n              }];\n          });\n        }\n      });\n    };\n\n    var register$2 = function (editor) {\n      editor.ui.registry.addContextToolbar('imagetools', {\n        items: getToolbarItems(editor),\n        predicate: function (elem) {\n          return getEditableImage(editor, elem).isSome();\n        },\n        position: 'node',\n        scope: 'node'\n      });\n    };\n\n    function Plugin () {\n      global.add('imagetools', function (editor) {\n        var imageUploadTimerState = Cell(0);\n        var lastSelectedImageState = Cell(null);\n        register(editor, imageUploadTimerState);\n        register$1(editor);\n        register$2(editor);\n        setup(editor, imageUploadTimerState, lastSelectedImageState);\n      });\n    }\n\n    Plugin();\n\n}());\n"]}